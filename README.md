# Приложение для установки PostgreSQL

## Description:
Это консольное приложение, которое устанавливает PostgreSQL на наименее загруженный server. По условию один сервер работает на CentOS (AlmaLinux), второй сервер работает на Debian.

Программа выбирает наименее загруженный сервер из двух, и делает ряд действий:
- подключение к удалённым хостам по SSH (через приватный ключ `ssh_key.pem`)
- выбор наименее нагруженного сервера как целевого проводился на основе первого значение `/proc/loadavg` (за последнюю минуту).
- установка PostgreSQL (разными способами в зависимости от ОС)
- настройка PostgreSQL:
  - включение внешних соединений (`listen_addresses = '*'`)
  - настройка `pg_hba.conf` для подключения пользователя `student` только с IP второго сервера
- проверка работы БД (`SELECT 1` через `psycopg2`)

### Инструменты
В разработке программы использовалось:
- языки: bash, python, ansible
- библиотеки: os, subprocess, re, sys, socket

## Инструкция по запуску

### Необходимые инструменты

**CentOS (AlmaLinux)**
На сервере CentOS (AlmaLinux) должен быть:
- установлен `openssh-server` или его аналог
- публичный ключ `~/.ssh/authorized_keys`
- python3 -V = 3.11

**Debian**
На сервере Debian должен быть:
- установлен `openssh-server` или его аналог
- публичный ключ `~/.ssh/authorized_keys`
- python3 -V >= 3.9

**Client (Для запуска программы)**
На клиенте, в корне проекта должен быть файл `ssh_key.pem` - тут будет находится приватный ssh ключ. 
Ключ должен иметь права `chmod 600`, иначе SSH будет ругаться.
На клиенте, должен находиться python >= `3.9`
На клиенте, должен находиться ansible
На клиенте, необходима команда `ssh`

### Шаги по запуску

1. Убедитесь, что на серверах Debian и CentOS (AlmaLinux) установлен и запущен openssh-server.
- На Debian сервере
    - `apt update` - Обновить репозитории
    - `apt install -y openssh-server` - Установить openssh-server  / или альтернативу ssh
    - `service ssh start` - Запуск openssh-server 
- На CentOS (AlmaLinux) сервере
    - `dnf install -y openssh-server` - Установить openssh-server / или альтернативу ssh
    - `/usr/sbin/sshd` - Запуск openssh-server 

2. Убедитесь, что ключ `authorized_keys`, находится в нужном месте
- На Debian сервере
    - `~/.ssh/authorized_keys` - Должен находиться публичный ключ по этому адресу
    - `chmod 600 ~/.ssh/authorized_keys` - Для корректного подключения, по ssh
- На CentOS (AlmaLinux) сервере
    - `~/.ssh/authorized_keys` - Должен находиться публичный ключ по этому адресу
    - `chmod 600 ~/.ssh/authorized_keys` - Для корректного подключения, по ssh

3. Убедитесь, что вы добавили приватный ключ `ssh_key.pem` - в корень проекта.
- `touch ssh_key.pem` - Выполните в корне проекта и положите туда приватный ключ
- `chmod 600 ssh_key.pem` - Выполните команду в корне проекта для корректного подключения, по ssh

4. Убедитесь, что на клиенте установлен **Ansible**

5. Выполните команду `chmod +x start-app.bash` - в корне проекта.

6. Выполните команду `./start-app.bash` - в корне проекта.

7. У вас будет выбор ввести данные для серверов, чтобы программа к ним подключилась
- Первый способ указать два ip в виде: ip,ip. Пример: `192.168.100.10,192.168.100.20`
- Второй способ указать ip,domain. Пример: `192.168.100.10,server.com`
- Третий способ указать domain,ip. Пример: `server.com,192.168.100.10`
- Четветый способ указать domain,domain. Пример: `server.com,server2.com`
8. Программа начинает выполнение

## Как проходило тестирование
В качестве клиента, была выбрана система `Ubuntu 22.04`.
- Тестирование проходило на трёх виртуальных машинах, где также, в качестве OS были выбраны (Ubuntu (client), CentOS (AlmaLinux), Debian).
- CentOS 9 (AlmaLinux) - server 1.
- Debian 12 - server 2.

Тестирование проводилось на арендованных серверах, при разной нагрузке.

Данная програма прошла тестирование.

## Что можно доработать
1. Можно добавить выбор версии PostgreSQL, для установки
2. Можно добавить лог файл с выводом процесса работы программы.
3. Можно доработать программу, чтобы она могла работать с большим количеством серверов.

## Какие вопросы/сложности возникли
1. Как протестировать программу при разной загрузке серверов. Я принял решение, провести тестирование на виртуальных машинах, чтобы ресурсы серверов, не были связаны.
2. Самым сложным было решить проблему с процессом установки PostgreSQL на CentOS (AlmaLinux), проблемы были:
- При установке PostgreSQL на CentOS (AlmaLinux) возникли сложности с конфигурацией репозиториев, так как по умолчанию система использует устаревшие репозитории для PostgreSQL, что требовало добавления внешних репозиториев. Это вызвало дополнительные проблемы с проверкой подписей пакетов, так как требуемая GPG-подпись отсутствовала в стандартных репозиториях. Временное отключение проверки GPG-подписей стало временным решением, однако на продакшен-серверах такая практика не рекомендуется.
- Также я столкнулся с проблемой, связанной с версией Python, установленной в системе. CentOS (AlmaLinux) по умолчанию использует Python 3.6 `/usr/libexec/platform-python` в качестве системного интерпретатора, что вызвало проблемы с некоторыми зависимостями для установки PostgreSQL. Для решения этой проблемы потребовалось установить более новую версию Python и настроить систему так, чтобы она использовала правильную версию для работы с PostgreSQL и другими зависимыми библиотеками.
3. Не понятно из ТЗ какая, версия PostgreSQL, поэтому взял PostgreSQL 14.


## Схема работы
https://drive.google.com/file/d/1NdN77X9QvwbaHn2sGXVsB-gqrc1sVk7G/view?usp=drive_link
