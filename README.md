# Приложение для установки postgreSQL

## Description:
Это консольное приложение, которое устанавливает postgreSQL на наименее загруженный server. По условию один сервер работает на CentOS (AlmaLinux), второй сервер работает на Debian.

Программа выбирает наименее загруженный сервер из двух, и делает ряд действий:
- подключение к удалённым хостам по SSH (через приватный ключ `ssh_key.pem`)
- оценку загруженности серверов (`load average`, а точнее его первый парраметр (Загруженность за последнюю минуту))
- выбор наименее нагруженного сервера как целевого
- установка PostgreSQL (разными способами в зависимости от ОС)
- настройка PostgreSQL:
  - включение внешних соединений (`listen_addresses = '*'`)
  - настройка `pg_hba.conf` для подключения пользователя `student` только с IP второго сервера
- проверка работы БД (`SELECT 1` через `psycopg2`)

### Инструменты
В разработке программы использовалось:
- языки: bash, python, ansible
- библиотеки: os, subprocess, re, sys

## Инструкция по запуску

### Необходимые инструменты

**CentOS (AlmaLinux)**
На сервере CentOS (AlmaLinux) должен быть установлен `openssh-server`
На сервере CentOS (AlmaLinux) должен быть публичный ключ `~/.ssh/authorized_keys`

**Debian**
На сервере Debian должен быть установлен openssh-server
На сервере Debian должен быть публичный ключ ~/.ssh/authorized_keys

**Client (Для запуска программы)**
На клиенте, в корне проекта должен быть файл `ssh_key.pem` - тут будет находится приватный ssh ключ. 
Ключ должен иметь права `chmod 600`, иначе SSH будет ругаться.
На клиенте, должен находиться **python** >= `3.9`
На клиенте, должен находиться **Ansible**
На клиенте, необходима команда `ssh`

### Шаги по запуску

1. Убедитесь, что на серверах Debian и CentOS (AlmaLinux) установлен и запущен openssh-server.
- На Debian сервере
    - `apt update` - Обновить репозитории
    - `apt install -y openssh-server` - Установить openssh-server 
    - `service ssh start` - Запуск openssh-server 
- На CentOS (AlmaLinux) сервере
    - `dnf install -y openssh-server` - Установить openssh-server 
    - `/usr/sbin/sshd` - Запуск openssh-server 

2. Убедитесь, что ключ `authorized_keys`, находится в нужном месте
- На Debian сервере
    - `~/.ssh/authorized_keys` - Должен находиться публичный ключ по этому адресу
    - `chmod 600 ~/.ssh/authorized_keys` - Для корректного подключения, по ssh
- На CentOS (AlmaLinux) сервере
    - `~/.ssh/authorized_keys` - Должен находиться публичный ключ по этому адресу
    - `chmod 600 ~/.ssh/authorized_keys` - Для корректного подключения, по ssh

3. Убедитесь, что вы добавили приватный ключ `ssh_key.pem` - в корень проекта.
- `touch ssh_key.pem` - Выполните в корне проекта и положите туда приватный ключ
- `chmod 600 ssh_key.pem` - Выполните команду в корне проекта для корректного подключения, по ssh

4. Убедитесь, что на клиенте установлен **Ansible**

5. Выполните команду `chmod +x start-app.bash` - в корне проекта.

6. Выполните команду `./start-app.bash` - в корне проекта.

7. У вас будет выбор ввести данные для серверов, чтобы программа к ним подключилась
- Первый способ указать два ip в виде: ip,ip. Пример: `192.168.100.10,192.168.100.20`
...

## Как проходило тестирование
В качестве клиента, была выбрана система `Ubuntu 24.04.1 LTS`.
Тестирование проходило в двух этапах:
- Первый этап, тестирование проводилось на локальной машине, в контейнерах докер. В ходе тестирования была создана локальная сеть и три контейнера (Ubuntu (client), CentOS (AlmaLinux), Debian)
- Второй этап проходил на трёх виртуальных машинах, где также, в качестве OS были выбраны (Ubuntu (client), CentOS (AlmaLinux), Debian).

Данная програма прошла тестирование.

## Что можно доработать
1. Можно добавить выбор версии PostgreSQL, для установки

## Какие вопросы возникли
1. Как протестировать программу при разной загрузке серверов. Я принял решение, провести тестирование на виртуальных машинах, чтобы ресурсы серверов, не были связаны.


## Схема работы
https://drive.google.com/file/d/1NdN77X9QvwbaHn2sGXVsB-gqrc1sVk7G/view?usp=drive_link
